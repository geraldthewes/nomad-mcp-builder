name: "submitJob"
description: |
  Submit a new Docker build job.

  IMPORTANT: This service runs on multiple build servers in a distributed cluster.
  Each server has its own build cache (Buildah layer cache), so consecutive builds
  may run on different servers with different cache states. If you need consistent
  build caching, consider this when troubleshooting build performance variations.

input_schema:
  type: "object"
  required: ["owner", "repo_url", "image_name", "image_tags", "registry_url"]
  properties:
    owner:
      type: "string"
      description: "Owner/organization of the repository"

    repo_url:
      type: "string"
      description: "Git repository URL"

    git_ref:
      type: "string"
      description: "Git reference (branch, tag, or commit)"
      default: "main"

    git_credentials_path:
      type: "string"
      description: "Vault path to git credentials"
      default: "secret/nomad/jobs/git-credentials"

    dockerfile_path:
      type: "string"
      description: "Path to Dockerfile in repository"
      default: "Dockerfile"

    image_name:
      type: "string"
      description: "Base name for the Docker image"

    image_tags:
      type: "array"
      items:
        type: "string"
      description: "List of image tags to apply"

    registry_url:
      type: "string"
      description: "Docker registry URL for final images"

    registry_credentials_path:
      type: "string"
      description: "Vault path to registry credentials"
      default: "secret/nomad/jobs/registry-credentials"

    test_commands:
      type: "array"
      items:
        type: "string"
      description: "List of test commands to run"

    test_entry_point:
      type: "boolean"
      description: "Whether to test the image entry point"
      default: false

    resource_limits:
      type: "object"
      description: |
        Resource limits for the build job. Supports both legacy global limits and per-phase limits.
        Units: CPU in MHz, Memory/Disk in MB.
        Recommended minimums:
        - Simple apps (1000 MHz, 2048 MB, 10240 MB)
        - Complex builds (2000 MHz, 4096 MB, 20480 MB)
        - Large ML/Data images (4000+ MHz, 8192+ MB, 40960+ MB)
      properties:
        # Legacy global limits (for backward compatibility)
        cpu:
          type: "string"
          description: |
            Global CPU limit in MHz (e.g., '2000' for 2 GHz). Applies to all phases if per-phase not specified.
            Minimum: 500, Recommended: 1000-4000 depending on complexity.
          examples: ["1000", "2000", "4000"]

        memory:
          type: "string"
          description: |
            Global memory limit in MB (e.g., '4096' for 4 GB). Applies to all phases if per-phase not specified.
            Minimum: 1024, Recommended: 2048-8192 depending on image size.
          examples: ["2048", "4096", "8192"]

        disk:
          type: "string"
          description: |
            Global disk limit in MB (e.g., '20480' for 20 GB). Applies to all phases if per-phase not specified.
            Minimum: 5120, Recommended: 10240-40960 depending on dependencies.
          examples: ["10240", "20480", "40960"]

        # Per-phase resource limits
        build:
          type: "object"
          description: |
            Resource limits for the build phase (compiling, dependency installation).
            Generally needs the most resources due to compilation and package downloads.
          properties:
            cpu:
              type: "string"
              description: "CPU limit in MHz. Recommended: 2000-4000 for complex builds, 1000 for simple apps."
              examples: ["1000", "2000", "4000"]
            memory:
              type: "string"
              description: "Memory limit in MB. Recommended: 4096-8192 for complex builds, 2048 for simple apps."
              examples: ["2048", "4096", "8192"]
            disk:
              type: "string"
              description: "Disk limit in MB. Recommended: 20480-40960 for builds with many dependencies, 10240 for simple apps."
              examples: ["10240", "20480", "40960"]

        test:
          type: "object"
          description: |
            Resource limits for the test phase (running tests in the built image).
            Usually needs moderate resources.
          properties:
            cpu:
              type: "string"
              description: "CPU limit in MHz. Recommended: 1000-2000 for most applications."
              examples: ["1000", "1500", "2000"]
            memory:
              type: "string"
              description: "Memory limit in MB. Recommended: 2048-4096 depending on test requirements."
              examples: ["2048", "3072", "4096"]
            disk:
              type: "string"
              description: "Disk limit in MB. Recommended: 5120-10240 for test artifacts and temporary files."
              examples: ["5120", "8192", "10240"]

        publish:
          type: "object"
          description: |
            Resource limits for the publish phase (pushing final images to registry).
            Generally needs minimal resources.
          properties:
            cpu:
              type: "string"
              description: "CPU limit in MHz. Recommended: 500-1000 (lightweight registry operations)."
              examples: ["500", "750", "1000"]
            memory:
              type: "string"
              description: "Memory limit in MB. Recommended: 1024-2048 (mainly for image manipulation)."
              examples: ["1024", "1536", "2048"]
            disk:
              type: "string"
              description: "Disk limit in MB. Recommended: 2048-5120 (temporary space for image layers)."
              examples: ["2048", "3072", "5120"]